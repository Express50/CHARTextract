<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


    <!--JQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <meta charset="UTF-8">

    <style>
        .with-margin-left {

            margin-left: 20px;
        }

        .with-margin-top {

            margin-top: 30px
        }
        .line-break-and-tab {

            white-space: pre-line;
            word-break: break-all;

        }
        .with-margin-bot {
            margin-bottom:10px;
        }
        .patient-links {
            margin-left: 10px;
            margin-right: 10px;
            background-color: #eee;
            width: 100px;
            color: #000;
        }

        .tooltip.top .tooltip-inner {
            background-color:#000;
            color: #fff;
            text-align: left;
        }

        .tooltip.top .tooltip-arrow {
            border-top-color: #000;
        }

    </style>

    <script>

        function isEmpty(obj)
        {
            for (var key in obj) {
                if(obj.hasOwnProperty(key))
                    return false;
            }

            return true;
        }

        function insert_span(sentence, match_text, span_id, colour)
        {
            regex = new RegExp(match_text + "(?!(<\/span>))");
            sentence = sentence.replace(regex, '<span id="' + span_id + '">' + match_text + "</span>");

            return sentence;
        }

        function isInArray(value, array)
        {
            return array.indexOf(value) > -1;
        }

        function insert_spans_single_class(text, class_name, class_matches_obj, colour, id_to_info)
        {
            var sentences = text.split(".");
            var sentence_indices = Object.keys(class_matches_obj);
            var new_text = "";

            for (var i =0; i < sentences.length; i++)
            {
                var new_sentence = sentences[i];
                if (isInArray(i.toString(), sentence_indices))
                {
                    var sentence_matches = class_matches_obj[i.toString()];

                    for (var k in sentence_matches)
                    {
                        match_text = sentence_matches[k].matched_string;
                        span_id = i + class_name + k;

                        new_sentence = insert_span(new_sentence, match_text, span_id, colour);
                        id_to_info[span_id] = {"colour": colour, "matches": sentence_matches[k], "class": class_name};
                    }
                }

                new_text += i < sentences.length - 1 ? new_sentence + "." : new_sentence;
            }

            return new_text;
        }

        function insert_spans(text, matches_obj, classes_to_colour, id_to_info) 
        {
            var class_names = Object.keys(classes_to_colour);
            var modified_text = text;

            for (var i = 0; i < class_names.length; i++)
            {
                var cur_name = class_names[i];
                var colour = classes_to_colour[cur_name];

                modified_text = insert_spans_single_class(modified_text, cur_name, matches_obj[cur_name], colour, id_to_info);
            }

            return modified_text;
        }



       $.ajax({
            url: 'smoking_report.json',
            dataType: 'json',
            success: function(data)
            {

                json_file = data;
                var_name = data.var_name
                $('#variablename').text(var_name + ' Classification Report')

                class_names = Object.keys(data.classes)
                classes_json = data.classes

                for (i = 0; i < class_names.length; i++)
                {
                    cur_name = class_names[i]
                    colour = classes_json[cur_name]
                    h4_object = '<div class="row with-margin-left with-margin-bot"><span class="h4">' + cur_name + '</span></div>'

                    $("#classes_container").append(h4_object)
                    $("#classes_container div span:eq(" + i + ")").css("background-color", colour)

                    patients = Object.keys(data.patient_cases)
                    patients_json = data.patient_cases
                    for (j = 0; j < patients.length; j++)
                    {
                        id = patients[j]
                        if (patients_json[id].pred == cur_name)
                        {
                            id_link = '<a class="patient-links" href="#" id="' + id + '"">' + id + '</a>'
                            $("#classes_container div:eq(" + i + ")").append(id_link)
                            $("#" + id).css("background-color", classes_json[patients_json[id].actual])
                        }
                    }
                }

                $(".patient-links").click(function(e)
                {
                    clicked_id = e.target.id
                    classification = data.patient_cases[clicked_id].pred
                    score = data.patient_cases[clicked_id].score[classification]
                    text_data = data.patient_cases[clicked_id].data
                    var span_id_to_info = {}
                    text_data = insert_spans(text_data, data.patient_cases[clicked_id].matches, data.classes, span_id_to_info);
                    text_data = text_data.replace(/\\n/g,"\n")
                    $("#case-no").text("Patient #ID: " + clicked_id)
                    $("#classification").text("Classified as: " + classification)
                    $("#score").text("Score: " + score)
                    $("#patient-text").html(text_data)

                    for (var id in span_id_to_info)
                    {
                        $("#" + id).css("background-color", span_id_to_info[id].colour)
                        $("#" + id).attr("data-toggle","tooltip")
                        $("#" + id).attr("data-html", "true")
                        tooltip_text = "name: " + span_id_to_info[id].matches.name +
                        "</br>class: " + span_id_to_info[id].class +
                        "</br>score: " + span_id_to_info[id].matches.score +
                        "</br>pattern: " + span_id_to_info[id].matches.pattern +
                        "</br>matched_string: " + span_id_to_info[id].matches.matched_string
                        $("#" + id).attr("title", tooltip_text)


                    }

                    $('[data-toggle="tooltip"]').tooltip();


                });

            }

        });

    </script>

    <title>Classification Report</title>
</head>
<body>
<div class="container-fluid">

    <div class="row">
        <div class="col">
            <h2 id="variablename" class="text-center">Classification Report</h2>
        </div>
    </div>

    <div class="row">
        <div class="col" style="padding-left: 20px">
            <h3 id="case-no">Patient #ID</h3>
        </div>
    </div>

    <!-- TODO: FIX BUTTON ALIGNMENT -->

    <div class="row">
        <div class="col" style="padding-left: 20px">
            <h3>Classifications:</h3>
        </div>
    </div>

    <div id="classes_container">
    </div>

    <div class="row with-margin-top">
        <div class="col" style="padding-left: 20px">
            <h4 id="classification">Classified as</h4>
        </div>
    </div>

   <!--  <div class="row">
        <div class="col" style="padding-left: 20px">
            <h4 id="actual">Actual: </h4>
        </div>
    </div> -->

    <div class="row">
        <div class="col" style="padding-left: 20px">
            <h4 id="score">Score: </h4>
        </div>
    </div>

    <div class="row">
        <div id="patient-text" class="col line-break-and-tab with-margin-top" style= "padding-left: 20px;" ></div>
    </div>
</div>
</body>
</html>