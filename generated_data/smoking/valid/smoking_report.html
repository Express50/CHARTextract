<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


    <!--JQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <meta charset="UTF-8">

    <style>
        .with-margin-left {

            margin-left: 20px;
        }

        .with-margin-top {

            margin-top: 30px
        }
        .line-break-and-tab {

            white-space: pre-line;
            word-break: break-all;

        }
        .with-margin-bot {
            margin-bottom:10px;
        }
        .patient-links {
            margin-left: 10px;
            margin-right: 10px;
            background-color: #eee;
            width: 100px;
            color: #000;
        }

    </style>

    <script>

        function isEmpty(obj)
        {
            for (var key in obj) {
                if(obj.hasOwnProperty(key))
                    return false;
            }

            return true;
        }

        function highlight_matches(text, matches_obj, classes_to_colour) {

            class_names = Object.keys(classes_to_colour)

            for (i = 0; i < class_names.length; i++)
            {
                cur_name = class_names[i]
                colour = classes_to_colour[cur_name]

                if (!isEmpty(matches_obj[cur_name]))
                {
                    sentence_indices = Object.keys(matches_obj[cur_name])
                    sentences = text.split(".")

                    for (j in sentence_indices)
                    {
                        index = sentence_indices[j]
                        sentence_matches = matches_obj[cur_name][index.toString()]
                        sentence = sentences[index]
                        sentence_mutate = sentences[index]

                        for (k in sentence_matches)
                        {
                            match_start = sentence_matches[k].match_start
                            match_end = sentence_matches[k].match_end
                        }
                    }

                }

                //if(matches_obj[cur_name] == {})
            }

        }


       $.ajax({
            url: 'smoking_report.json',
            dataType: 'json',
            success: function(data)
            {
                json_file = data;
                var_name = data.var_name
                $('#variablename').text(var_name + ' Error Report')

                class_names = Object.keys(data.classes)
                classes_json = data.classes

                for (i = 0; i < class_names.length; i++)
                {
                    cur_name = class_names[i]
                    colour = classes_json[cur_name]
                    h4_object = '<div class="row with-margin-left with-margin-bot"><span class="h4">' + cur_name + '</span></div>'

                    $("#classes_container").append(h4_object)
                    $("#classes_container div span:eq(" + i + ")").css("background-color", colour)

                    patients_errors = Object.keys(data.patient_cases)
                    patients_json = data.patient_cases
                    for (j = 0; j < patients_errors.length; j++)
                    {
                        id = patients_errors[j]
                        if (patients_json[id].actual == cur_name)
                        {
                            id_link = '<a class="patient-links" href="#" id="' + id + '"">' + id + '</a>'
                            $("#classes_container div:eq(" + i + ")").append(id_link)
                            $("#" + id).css("background-color", classes_json[patients_json[id].pred])
                        }
                    }

                    console.log(cur_name)
                    console.log(colour)
                }

                $(".patient-links").click(function(e)
                {
                    clicked_id = e.target.id
                    classification = data.patient_cases[clicked_id].pred
                    actual = data.patient_cases[clicked_id].actual
                    score = data.patient_cases[clicked_id].score[classification]
                    text_data = data.patient_cases[clicked_id].data
                    highlight_matches(text_data, data.patient_cases[clicked_id].matches, data.classes)
                    text_data = text_data.replace(/\\n/g,"\n")
                    $("#case-no").text("Patient #ID: " + clicked_id)
                    $("#classification").text("Classified as: " + classification)
                    $("#actual").text("Actual: " + actual)
                    $("#score").text("Score: " + score)
                    $("#patient-text").html(text_data)

                });
                
            }

        });      

    </script>

    <title>Error Report</title>
</head>
<body>
    <div class="container-fluid">

        <div class="row">
            <div class="col">
                <h2 id="variablename" class="text-center"> Smoking Status Error Report</h2>
            </div>
        </div>

        <div class="row">
          <div class="col" style="padding-left: 20px">
              <h3 id="case-no">Patient #ID</h3>
          </div>
        </div>

        <!-- TODO: FIX BUTTON ALIGNMENT -->

        <div class="row">
            <div class="col" style="padding-left: 20px">
                <h3>Misclassifications:</h3>
            </div>
        </div>

        <div id="classes_container">
        </div>  

        <div class="row with-margin-top">
            <div class="col" style="padding-left: 20px">
                <h4 id="classification">Classified as</h4>
            </div>
        </div>

        <div class="row">
            <div class="col" style="padding-left: 20px">
                <h4 id="actual">Actual: </h4>
            </div>
        </div>

        <div class="row">
            <div class="col" style="padding-left: 20px">
                <h4 id="score">Score: </h4>
            </div>
        </div>

        <div class="row">
            <p id="patient-text" class="col line-break-and-tab with-margin-top" style= "padding-left: 20px;" ></p>
        </div>
    </div>
</body>
</html>